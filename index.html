<!DOCTYPE html>
<meta charset="utf-8">
<title>Jetpack Reviewer Dashboard</title>
<script src="js/jquery.js"></script>
<script src="js/bugzilla.js"></script>
<script src="js/date-utils.js"></script>
<script>
var WEEK_MS = 1000 * 60 * 60 * 24 * 7;

function getReviewerInfo(email, numWeeksAgo, cb) {
  var requestsLeft = 0;
  var result = {
    reviewsPending: 0,
    reviewsDone: new Array(numWeeksAgo)
  };

  Bugzilla.ajax({
    url: "/count",
    data: {
      status: ["NEW", "UNCONFIRMED", "ASSIGNED", "REOPENED"],
      'flag.requestee': email,
      'product': 'Mozilla Labs',
      'component': 'Jetpack SDK',
      'changed_field': 'flag',
      'changed_after': timeAgo(WEEK_MS * numWeeksAgo)
    },
    success: function(data) {
      result.reviewsPending = data.data;
      if (--requestsLeft == 0)
        cb(result);
    }
  });
  requestsLeft += 1;

  function getReviewsForWeek(numWeeksAgo) {
    Bugzilla.ajax({
      url: "/count",
      data: {
        'flag.setter': email,
        'product': 'Mozilla Labs',
        'component': 'Jetpack SDK',
        'changed_field': 'flag',
        'changed_before': timeAgo(WEEK_MS * numWeeksAgo),
        'changed_after': timeAgo(WEEK_MS * (numWeeksAgo + 1))
      },
      success: function(data) {
        result.reviewsDone[numWeeksAgo] = data.data;
        if (--requestsLeft == 0)
          cb(result);
      }
    });
    requestsLeft += 1;
  }

  for (var i = 0; i < numWeeksAgo; i++)
    getReviewsForWeek(i);
}

$(window).ready(function() {
  getReviewerInfo('avarma@mozilla.com', 8, function(result) {
    result.reviewsDone.reverse();
    var code = "sparkline(" + JSON.stringify(result.reviewsDone) + ")";
    console.log("code is", code);
    $(".name").before($("<script></" + "script>").text(code));
    //console.log(JSON.stringify(result));
  });
});
</script>
<script src="js/protovis-r3.2.js"></script>
<script>
/** A simple sparkline with optional dots. */
function sparkline(data, dots) {
  var n = data.length,
      w = n,
      h = 10,
      min = pv.min.index(data),
      max = pv.max.index(data);

  var vis = new pv.Panel()
      .width(w)
      .height(h)
      .margin(2);

  vis.add(pv.Line)
      .data(data)
      .left(pv.Scale.linear(0, n - 1).range(0, w).by(pv.index))
      .bottom(pv.Scale.linear(data).range(0, h))
      .strokeStyle("#000")
      .lineWidth(1)
    .add(pv.Dot)
      .visible(function() { return (dots && this.index == 0) || this.index == n - 1})
      .strokeStyle(null)
      .fillStyle("brown")
      .radius(2)
    .add(pv.Dot)
      .visible(function() { return dots && (this.index == min || this.index == max) })
      .fillStyle("steelblue");

  vis.render();
}

/** A sparkline bar chart. */
function sparkbar(data) {
  var w = 60,
      h = 12;

  var vis = new pv.Panel()
      .width(w)
      .height(h);

  vis.add(pv.Bar)
      .data(data)
      .width(4)
      .left(function() { return 5 * this.index })
      .height(function(d) { return Math.round(h * d) })
      .bottom(0);

  vis.render();
}
</script>
<div class="entry">
  <span class="name">Atul</span>
</div>
